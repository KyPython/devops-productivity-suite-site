# DevOps Productivity Suite Improvements - Port Configuration

## Problem
The suite generates start/stop scripts with **hardcoded ports**, requiring manual fixes. This is a fundamental flaw that should be fixed at the source.

## Required Improvements

### 1. **Port Configuration System**
**Current:** Ports hardcoded in generated scripts  
**Needed:** Centralized port configuration

```bash
# Suite should generate/use a port config file:
# .devops/ports.conf or .devops/config.yaml

ports:
  frontend: ${FRONTEND_PORT:-3000}
  backend: ${PORT:-3030}
  automation: ${AUTOMATION_PORT:-7070}
  metrics: ${BACKEND_METRICS_PORT:-9091}
  observability:
    grafana: 3001
    prometheus: 9090
    loki: 3100
    tempo: 3200
    otel: 4318
```

### 2. **Dynamic Port Generation**
**Current:** Scripts have `for port in 3000 3030 7070...`  
**Needed:** Scripts should read from config/env

```bash
# Generated scripts should:
# 1. Load port config
# 2. Use variables throughout
# 3. Support .env overrides

source .devops/load-ports.sh  # Generated by suite
FRONTEND_PORT=${FRONTEND_PORT:-3000}
BACKEND_PORT=${PORT:-3030}
# ... etc
```

### 3. **Start/Stop Script Synchronization**
**Current:** Start and stop scripts can drift  
**Needed:** Single source of truth

- Suite should generate both from same config
- Port changes in one automatically update the other
- Validation step ensures they match

### 4. **Port Conflict Detection**
**Current:** Scripts kill processes on ports, but no validation  
**Needed:** Pre-flight checks

```bash
# Suite should generate:
check_port_available() {
  local port=$1
  if lsof -ti :$port > /dev/null 2>&1; then
    echo "ERROR: Port $port in use"
    echo "  Process: $(lsof -ti :$port | xargs ps -p)"
    return 1
  fi
}
```

### 5. **Environment Variable Integration**
**Current:** Scripts don't consistently read .env  
**Needed:** Standardized env loading

```bash
# Suite should generate standard pattern:
load_env_config() {
  [ -f .env ] && export $(cat .env | grep -v '^#' | xargs)
  [ -f .devops/config.env ] && export $(cat .devops/config.env | grep -v '^#' | xargs)
  set_port_defaults
}
```

### 6. **Dependency Detection & Installation**
**Current:** We manually added dependency checking  
**Needed:** Suite should generate this automatically

```bash
# Suite should detect package.json/requirements.txt and generate:
check_and_install_deps() {
  # Auto-detect: npm, pip, yarn, etc.
  # Auto-install if missing
  # Support multiple package managers
}
```

### 7. **Health Check URL Generation**
**Current:** Health check URLs hardcoded  
**Needed:** Dynamic based on port config

```bash
# Generated health checks should use:
BACKEND_HEALTH="http://localhost:${BACKEND_PORT}/health"
AUTOMATION_HEALTH="http://localhost:${AUTOMATION_PORT}/health"
```

### 8. **Configuration Validation**
**Current:** No validation of port configs  
**Needed:** Pre-generation validation

- Detect port conflicts in config
- Validate port ranges (1024-65535)
- Check for duplicate ports
- Warn about common port conflicts

### 9. **Template System**
**Current:** Scripts are monolithic  
**Needed:** Modular templates

```
.devops/templates/
  ├── start-dev.sh.template
  ├── stop-dev.sh.template
  ├── health-check.sh.template
  └── port-config.sh.template
```

### 10. **Update/Migration Path**
**Current:** Manual fixes required  
**Needed:** Migration tool

```bash
# Suite should provide:
devops-suite migrate-ports
# Scans existing scripts
# Extracts hardcoded ports
# Generates config file
# Updates scripts to use config
```

## Implementation Priority

### Critical (Must Have)
1. **Port Configuration System** - Single source of truth
2. **Dynamic Port Generation** - Scripts read from config
3. **Start/Stop Synchronization** - Both use same config

### High Priority
4. **Environment Variable Integration** - Standard .env loading
5. **Dependency Detection** - Auto-install missing deps
6. **Health Check URLs** - Dynamic based on ports

### Medium Priority
7. **Port Conflict Detection** - Pre-flight validation
8. **Configuration Validation** - Catch errors early

### Nice to Have
9. **Template System** - Modular generation
10. **Migration Tool** - Upgrade existing scripts

## Example: What Generated Scripts Should Look Like

```bash
#!/bin/bash
# Auto-generated by devops-suite v2.0
# DO NOT EDIT - Regenerate with: devops-suite generate

# Load port configuration
source .devops/load-ports.sh

# Load environment
load_env_config

# Use dynamic ports throughout
for port in $FRONTEND_PORT $BACKEND_PORT $AUTOMATION_PORT; do
  check_port_available $port || exit 1
done

# Health checks use dynamic ports
BACKEND_HEALTH="http://localhost:$BACKEND_PORT/health"
curl -s $BACKEND_HEALTH || exit 1
```

## Testing Requirements

The suite should generate scripts that:
- ✅ Work with default ports
- ✅ Work with .env overrides
- ✅ Detect port conflicts
- ✅ Install missing dependencies
- ✅ Keep start/stop scripts in sync
- ✅ Handle port changes gracefully

## Backward Compatibility

- Suite should detect old-style scripts
- Offer migration path
- Preserve custom modifications where possible
- Generate migration report

---

**Last Updated:** 2025-12-20  
**Priority:** Critical  
**Status:** Needs Implementation
